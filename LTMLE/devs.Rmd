
```{r, include=F}
#remotes::install_github("Larsvanderlaan/tmle3", ref = "devel")


devtools::document()
```

```{r}


# Generate simple causal model
library(simcausal)

D <- DAG.empty()
D <- D +
  node("W", distr = "runif", min =-1, max = 1) +
  node("A", distr = "rbinom", size = 1, prob = 0.5 + W/4 ) +
  node("T", distr = "rexp", rate = 0.05*(1 + 0.5*A - 0.3*W) )+
  node("C", distr = "rexp",  rate = 0.03*(1 + 0.4*A - 0.2*W)) +
  node("Delta", distr = "rconst", const = as.numeric(T<=C)  ) +
  node("Ttilde", distr = "rconst", const = round(min(T,C,10) +1  ))
setD <- set.DAG(D)
dat <- sim(setD, n = 1e2)
# only grab ID, W's, A, T.tilde, Delta
Lname <- grep("W", colnames(dat), value = TRUE)
Aname <- grep("A", colnames(dat), value = TRUE)
df <- dat[, c("ID", Lname, Aname, "T", "C", "Delta", "Ttilde")]

data <- df[,c( "W", "A", "Ttilde", "Delta")]
data$id = df$ID

data$t <- data$Ttilde 
data = data.table(data)
data$processA = as.numeric(data$Delta ==0)
data$processN = as.numeric(data$Delta ==1)
data_baseline <- data
data_baseline$t =0
data_baseline$processA = 0
data_baseline$processN = 0
data_baseline$Ttilde = NA
data_baseline$Delta = NA
data = rbind(data_baseline, data)
data$Ttilde = NULL
data$Delta = NULL
data$at_risk = 1 - (data$processA + data$processN)
npsem = list(define_lnode("W", c("W"), time =0), 
     define_lnode("A", c("A"), c("W"), time =0, summary_functions = make_summary_measure_baseline(c("W"))),
     
     define_lnode("processA", c("processA"),  c("A","W"), time = "pooled", summary_functions = make_summary_measure_baseline(c("A", "W")),
                  at_risk_summary_function = make_summary_measure_last_value("at_risk", strict_past  = F), node_type = "counting_process",
                  include_competing_risks = F),
     
define_lnode("processN", c("processN"), c("A","W"),time = "pooled", summary_functions = make_summary_measure_baseline(c("A", "W")),
                  at_risk_summary_function = make_summary_measure_last_value("at_risk", strict_past = T), node_type = "counting_process",
                  include_competing_risks = F))
# Delta is the counting process which is 1 at death
```


```{r}

data
```



```{r}
task = ltmle3_Task$new(data, npsem)


 
 lik = generate_likelihood_surv(task)

```

```{r}
lik = lik$train(task)
```

```{r}
cf_data = task$data[, processN, processA]
cf_data$processN =1
cf_data$processA =1
cf_data
cf_task = task$generate_counterfactual_task(task$uuid, new_data = cf_data)
cf_task$data

cf_task$get_regression_task("processN", force_time_value = 2)$data
```
```{r}
preds=lik$get_likelihood(task, "processN")
preds
```

```{r}
a = task$get_regression_task("A")
a$t
```

```{r}
task_all = task$get_regression_task("processN",  drop_censored = F)
task_all$internal_data$raw_data

```

```{r}
lik$get_likelihood(task, "processN")
preds[10000:11000,]

```


```{r}

# Generate simple causal model
library(simcausal)

D <- DAG.empty()
D <- D +
  node("L0", distr = "runif", min =0, max = 1) +
  node("A0", distr = "rbinom", size = 1, prob = 0.5) +
  node("L1", distr = "runif", min =0, max = 1 + 0.5*A0) +
  node("A1", distr = "rbinom", size = 1, prob = L0/8 + .15 + .5 * as.numeric(A0 > .75)) +
  node("Y", distr = "rnorm", mean = A1 + 0.5* A0 - L0 - 0.5*L1  )
setD <- set.DAG(D)
dat <- sim(setD, n = 2e2)
# only grab ID, W's, A, T.tilde, Delta
Lname <- grep("L", colnames(dat), value = TRUE)
Aname <- grep("A", colnames(dat), value = TRUE)
df <- dat[, c("ID", Lname, Aname, "Y")]
df
# The simulator will generate death at time 0.
# our package only allow positive integer time, so I add one to all times
name0 <- grep("0", colnames(dat), value = TRUE)
name1 <- grep("1", colnames(dat), value = TRUE)
df1 = df[,name0]
df1$t <- rep(1, nrow(df1))
colnames(df1) = c("L", "A", "t")
df2 = df[,name1]
df2$t <- rep(2, nrow(df2))
colnames(df2) = c("L", "A", "t")
final <- rbind(df1, df2)
final$Y <- c(rep(NA, nrow(df1)), df$Y)
final$id <- c(df$ID, df$ID)
final <- data.table(final[,c("id", "t", "L", "A", "Y")])
final
```





```{r}
final$A_at_risk = c(rep(1,200), rep(1,200))

npsem <- generate_npsem(final, "L", "L", "A", "Y")

task = ltmle3_Task$new(final, npsem)

tsk = task$get_regression_task("A1", drop_censored = F)
tsk$get_data()
tsk$X
likelihood <- generate_likelihood(task)

```





```{r}
k=likelihood$train(task)
(likelihood$get_likelihood(task, "Y"))

```


```{r}
reduce_f <- function(x,y){
 
  out = list()
  names_out <- names(x)
  for(i in seq_along(x)){
   
    out[[names_out[i]]] <- cbind(x[[i]], y[[i]])
  }
  return(out)
}
list(list(a=1,b=2,c=3), list(a=1,b=2,c=3)) %>% reduce(reduce_f)
```


```{r}
probs
collapse_nodes <- list("P" = c("L0", "L1", "A0", "A1", "Y"))
factors = c(k$factor_list$A0, k$factor_list$A1)

collapsed_k = Collapsed_Likelihood$new(k,collapse_nodes )
collapsed_k$factor_list

collapsed_k$get_likelihoods(task)
collapsed_k$get_hidden_nodes("P")
```

```{r}
collapsed_k$factor_list

```

```{r}
c=LF_emp$new(c("a","b"))
c$name
```

```{r}

lik = generate_likelihood(task)
lik$validate_task(task)

lik$train(task)
```

```{r}
task$weights

```


```{r}
lik1 = lik$train(task)

lik1$get_likelihoods(task)
lik1$get_likelihoods(task, "L0")
```

```{r}

devtools::document()
```


