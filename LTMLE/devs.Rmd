
```{r, include=F}
#remotes::install_github("Larsvanderlaan/tmle3", ref = "devel")

library(tmle3)
devtools::document()
```


```{r}

# Generate simple causal model
library(simcausal)

D <- DAG.empty()
D <- D +
  node("L0", distr = "runif", min =0, max = 1) +
  node("A0", distr = "rbinom", size = 1, prob = 0.5) +
  node("L1", distr = "runif", min =0, max = 1 + 0.5*A0) +
  node("A1", distr = "rbinom", size = 1, prob = L0/8 + .15 + .5 * as.numeric(A0 > .75)) +
  node("Y", distr = "rnorm", mean = A1 + 0.5* A0 - L0 - 0.5*L1  )
setD <- set.DAG(D)
dat <- sim(setD, n = 2e2)
# only grab ID, W's, A, T.tilde, Delta
Lname <- grep("L", colnames(dat), value = TRUE)
Aname <- grep("A", colnames(dat), value = TRUE)
df <- dat[, c("ID", Lname, Aname, "Y")]
df
# The simulator will generate death at time 0.
# our package only allow positive integer time, so I add one to all times
name0 <- grep("0", colnames(dat), value = TRUE)
name1 <- grep("1", colnames(dat), value = TRUE)
df1 = df[,name0]
df1$t <- rep(1, nrow(df1))
colnames(df1) = c("L", "A", "t")
df2 = df[,name1]
df2$t <- rep(2, nrow(df2))
colnames(df2) = c("L", "A", "t")
final <- rbind(df1, df2)
final$Y <- c(rep(NA, nrow(df1)), df$Y)
final$id <- c(df$ID, df$ID)
final <- data.table(final[,c("id", "t", "L", "A", "Y")])
final
```




```{r}
task = ltmle3_Task$new(final, npsem)
task$get_data()
tsk = task$get_regression_task("Y")
tsk$data

```





```{r}

#all.equal(unlist(task$nodes), unlist(task$nodes))
task$get_regression_task("Y")$data

#task$get_regression_task("A1")$data
#copy_task = task$get_regression_task(c("A0", "A1"))
#copy_task$data
```






```{r}
tmle3_Task$init

```


```{r}
d = data.table( c(1,1), c(1,1))
colnames(d) <- c("A1", "A0")
task$X
cf_task = task$generate_counterfactual_task("1234", d)
cf_task$data
```

```{r}
c=LF_emp$new(c("a","b"))
c$name
```

```{r}

lik = generate_likelihood(task)
lik$validate_task(task)

lik$train(task)
```

```{r}
task$weights

```


```{r}
lik1 = lik$train(task)

lik1$get_likelihoods(task)
lik1$get_likelihoods(task, "L0")
```

```{r}

devtools::document()
```


