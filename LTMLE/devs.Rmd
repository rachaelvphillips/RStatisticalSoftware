
```{r, include=F}
remotes::install_github("Larsvanderlaan/tmle3", ref = "devel")

library(tmle3)
devtools::document()
```


```{r}

observed <- c(1,1,2,2,2,3)
uniq_obs <- unique(observed)
counts <- as.list(rep(0, length(uniq_obs)))
names(counts) <- uniq_obs
for(obs in uniq_obs){
  counts[[obs]] <- sum(observed == obs)
  
}

matched_obs <- match(observed, uniq_obs)
weights <- as.vector(sapply(matched_obs, function(i) counts[[i]]))
weights / sum(weights)
```

```{r}

# Generate simple causal model
library(simcausal)

D <- DAG.empty()
D <- D +
  node("L0", distr = "runif", min =0, max = 1) +
  node("A0", distr = "rbinom", size = 1, prob = 0.5) +
  node("L1", distr = "runif", min =0, max = 1 + 0.5*A0) +
  node("A1", distr = "rbinom", size = 1, prob = L0/8 + .15 + .5 * as.numeric(A0 > .75)) +
  node("Y", distr = "rnorm", mean = A1 + 0.5* A0 - L0 - 0.5*L1  )
setD <- set.DAG(D)
dat <- sim(setD, n = 2e2)
# only grab ID, W's, A, T.tilde, Delta
Lname <- grep("L", colnames(dat), value = TRUE)
Aname <- grep("A", colnames(dat), value = TRUE)
df <- dat[, c("ID", Lname, Aname, "Y")]
df
# The simulator will generate death at time 0.
# our package only allow positive integer time, so I add one to all times
name0 <- grep("0", colnames(dat), value = TRUE)
name1 <- grep("1", colnames(dat), value = TRUE)
df1 = df[,name0]
df1$t <- rep(1, nrow(df1))
colnames(df1) = c("L", "A", "t")
df2 = df[,name1]
df2$t <- rep(2, nrow(df2))
colnames(df2) = c("L", "A", "t")
final <- rbind(df1, df2)
final$Y <- c(rep(NA, nrow(df1)), df$Y)
final$id <- c(df$ID, df$ID)
final <- data.table(final[,c("id", "t", "L", "A", "Y")])
final
```


```{r}
task = ltmle3_Task$new(final, npsem)
task$get_tmle_node("L0", include_id = T, format = T)
task$get_regression_task("L0")

```


```{r}
final$A_at_risk = c(rep(1,200), rep(1,200))

npsem <- generate_npsem(final, "L", "L", "A", "Y")

task = ltmle3_Task$new(final, npsem)

tsk = task$get_regression_task("A1", drop_censored = F)
tsk$get_data()
tsk$X
likelihood <- generate_likelihood(task)

```





```{r}
k=likelihood$train(task)
(likelihood$get_likelihood(task, "L0"))

```

`

```{r}
d = data.table( c(1,1), c(1,1))
colnames(d) <- c("A1", "A0")
task$X
cf_task = task$generate_counterfactual_task("1234", d)
cf_task$data
```

```{r}
c=LF_emp$new(c("a","b"))
c$name
```

```{r}

lik = generate_likelihood(task)
lik$validate_task(task)

lik$train(task)
```

```{r}
task$weights

```


```{r}
lik1 = lik$train(task)

lik1$get_likelihoods(task)
lik1$get_likelihoods(task, "L0")
```

```{r}

devtools::document()
```


