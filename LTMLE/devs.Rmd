
```{r, include=F}
#remotes::install_github("Larsvanderlaan/tmle3", ref = "devel")

library(tmle3)
devtools::document()
```




```{r}
library(tmle3)
library(data.table)

dt = data.table(cbind(c(1,2,1,2), c(1,1,3,3), c(1,1,0,1),c(1,0,1,0), c(1,1,1,0), c(1,1,2,2)))
colnames(dt) = c("t" ,"W", "L", "A", "Y", "id")




```




```{r}

#data: column names: baseline covariate, time dependent covariates (must be common to all times), treatment, time_index
#For each time dependent covariate, one needs to specify a summary measure. A summary measure is a function that takes takes a matrix of time dependent covariate (up until current time) and collapse the matrix to a vector of a fixed size.
num_time_points = 2
time_dep_cov = c("L", "A")
baseline_cov = c("W")
get_time_point = function(i){
  return(c(paste0("L",i), paste0("A",i)))
}
ltmle_nodes = c(unlist(lapply(seq_len(num_time_points)-1, get_time_point)), "Y")


time_ordered_nodes = ltmle_nodes

get_graph = function(i, nodes){
  if(i==1){
    parents = c()
    cov = baseline_cov
  }
  else{
    parents = time_ordered_nodes[1:(i-1)]
    if(i%%2==0){
      cov = time_dep_cov[2]
    } else {
      cov = time_dep_cov[1]
    }
  }
  time =  as.numeric(stringr::str_match(time_ordered_nodes[i],"[^0-9].*([0-9]+)")[2])+1
  if(time_ordered_nodes[i] == "Y"){
    cov = "Y"
    time = 2
  }
  
  sumry =  c( make_summary_measure_baseline(baseline_cov), make_summary_measure_last_value(time_dep_cov))
  if(i==1){
     sumry = make_summary_measure_NULL()
  }
  if(i==2){
     sumry = make_summary_measure_baseline(baseline_cov)
  }
  if(i==3){
     sumry =  c( make_summary_measure_baseline(baseline_cov), make_summary_measure_last_value(c("A")))
  }
  define_lnode(time_ordered_nodes[i], cov, parents,time,sumry, variable_type = sl3::variable_type("continuous")
)
}
full_npsem = lapply(seq_along(time_ordered_nodes), get_graph, time_ordered_nodes )
task = ltmle3_Task$new(dt, full_npsem)
task$get_data()
task$internal_data$raw_data
task$npsem
tsk = task$get_regression_task("Y")
tsk$X
```





```{r}

#all.equal(unlist(task$nodes), unlist(task$nodes))
task$get_regression_task("Y")$data

#task$get_regression_task("A1")$data
#copy_task = task$get_regression_task(c("A0", "A1"))
#copy_task$data
```






```{r}
tmle3_Task$init

```


```{r}
d = data.table( c(1,1), c(1,1))
colnames(d) <- c("A1", "A0")
task$X
cf_task = task$generate_counterfactual_task("1234", d)
cf_task$data
```

```{r}
c=LF_emp$new(c("a","b"))
c$name
```

```{r}

lik = generate_likelihood(task)
lik$validate_task(task)

lik$train(task)
```

```{r}
task$weights

```


```{r}
lik1 = lik$train(task)

lik1$get_likelihoods(task)
lik1$get_likelihoods(task, "L0")
```

```{r}

devtools::document()
```


