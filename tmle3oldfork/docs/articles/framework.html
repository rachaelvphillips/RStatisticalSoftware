<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>`tmle3` Framework Overview • tmle</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="`tmle3` Framework Overview">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115145808-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115145808-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tmle</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="http://tlverse.org">tlverse</a>
</li>
<li>
  <a href="../index.html">tmle3</a>
</li>
<li>
  <a href="../articles/framework.html">Overview</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tlverse/tmle3">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>
<code>tmle3</code> Framework Overview</h1>
                        <h4 class="author"><a href="https://github.com/jeremyrcoyle">Jeremy Coyle</a></h4>
            
            <h4 class="date">2020-03-06</h4>
      
      
      <div class="hidden name"><code>framework.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The <code>tmle3</code> package differs from previous TMLE software efforts in that it attempts to directly model the key objects defined in the mathematical and theoretical framework of Targeted Minimum Loss-Based Estimation (TMLE). That is, rather than focus on implementing a specific TML estimator, or a small set of related estimators, the focus is on modeling the TMLE <em>framework</em> itself.</p>
<p>Therefore, we explicitly define objects to model the NPSEM, the factorized likelihood, counterfactual interventions, parameters, and TMLE update procedures. The hope is that, in so doing, it will be possible to support a substantial subset of the vast array of TML estimators currently present in the literature, as well as those that have yet to be developed. In this vignette, we describe these mathematical objects, their software analogs in <code>tmle3</code>, and illustrate with a motivating example, described below. At the end, we describe how these objects can be bundled into a complete specification of a TML estimation procedure that can be easily applied by an end user.</p>
<div id="motivating-example" class="section level3">
<h3 class="hasAnchor">
<a href="#motivating-example" class="anchor"></a>Motivating Example</h3>
<p>We use data from the Collaborative Perinatal Project (CPP), available in the <code>sl3</code> package. To simplify this example, we define a binary intervention variable, <code>parity01</code> – an indicator of having one or more children before the current child and a binary outcome, <code>haz01</code> – an indicator of having an above average height for age.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tmle3)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sl3)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(cpp)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">cpp &lt;-<span class="st"> </span>cpp[<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(cpp[, <span class="st">"haz"</span>]), ]</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">cpp<span class="op">$</span>parity01 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(cpp<span class="op">$</span>parity <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">cpp[<span class="kw"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(cpp)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">cpp<span class="op">$</span>haz01 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(cpp<span class="op">$</span>haz <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a></code></pre></div>
</div>
</div>
<div id="npsem" class="section level1">
<h1 class="hasAnchor">
<a href="#npsem" class="anchor"></a>NPSEM</h1>
<p>TMLE requires the specification of a Nonparametric Structural Equation Model (NPSEM), which specifies our knowledge of relationships between the variables.</p>
<p>We start with a set of endogenous variables, <span class="math inline">\(X=(X_1,\ldots,X_J)\)</span>, that we want to model the relationship between. Each <span class="math inline">\(X_j\)</span> is at least partially observed in the dataset. The NPSEM defines each variable (<span class="math inline">\(X_j\)</span>) by a deterministic function (<span class="math inline">\(f_{X_j}\)</span>) of its parent nodes (<span class="math inline">\(Pa(X_j)\)</span>) and an exogenous random variable (<span class="math inline">\(U_{X_j}\)</span>):</p>
<p><span class="math display">\[X_j = f_{X_j}(Pa(X_j), U_{X_j}),\;\; j\in \{1, \ldots, J\}\]</span></p>
<p>The exact functional form of the functions <span class="math inline">\(f_{X_j}\)</span> is left unspecified at this step. If there is <em>a priori</em> knowledge for some of these functions, that can be specified during the likelihood step below.</p>
<div id="causal-considerations" class="section level3">
<h3 class="hasAnchor">
<a href="#causal-considerations" class="anchor"></a>Causal Considerations</h3>
<p>The collection of exogenous random variables defined by the NPSEM is <span class="math inline">\(U = (U_{X_1}, \ldots, U_{X_J})\)</span>. Typically, non-testable assumptions about the joint distribution of <span class="math inline">\(U\)</span> are necessary for identifiability of causal parameters with statistical parameters of the observed data. These assumptions are not managed in the <code>tmle3</code> framework, which instead focus on the statistical estimation problem. Therefore, those developing tools for end users need to be clear about the additional causal assumptions necessary for causal interpretation of estimates.</p>
</div>
<div id="example" class="section level3">
<h3 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h3>
<p>In the case of our CPP example, we use the classic point treatment NPSEM which defines three nodes: <span class="math inline">\(X = (W, A, Y)\)</span>, where <span class="math inline">\(W\)</span> is a set of baseline covariates, <span class="math inline">\(A\)</span> is our exposure of interest (<code>parity01</code>), and <span class="math inline">\(Y\)</span> is our outcome of interest (<code>haz01</code>). We define the following SCM:</p>
<p><span class="math display">\[W = f_W(U_W)\]</span> <span class="math display">\[A = f_A(W, U_A)\]</span> <span class="math display">\[Y = f_Y(W, U_Y)\]</span></p>
<p>In <code>tmle3</code>, this is done using the <code>define_node</code> function for each node. <code>define_node</code> allows a user to specify the node_name, which columns in the data comprise the node, and a list of parent nodes.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">npsem &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw"><a href="../reference/tmle3_Node.html">define_node</a></span>(<span class="st">"W"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="st">"apgar1"</span>, <span class="st">"apgar5"</span>, <span class="st">"gagebrth"</span>, <span class="st">"mage"</span>,</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="st">"meducyrs"</span>, <span class="st">"sexn"</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  )),</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="kw"><a href="../reference/tmle3_Node.html">define_node</a></span>(<span class="st">"A"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"parity01"</span>), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>)),</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="kw"><a href="../reference/tmle3_Node.html">define_node</a></span>(<span class="st">"Y"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"haz01"</span>), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>, <span class="st">"W"</span>))</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">)</a></code></pre></div>
<p>Nodes also track information about the data types of the variables (continuous, categorical, binomial, etc). Here, that information is being estimated automatically from the data. In the future, each node will also contain information about censoring indicators, where applicable, but this is not yet implemented.</p>
</div>
<div id="tmle3_task" class="section level3">
<h3 class="hasAnchor">
<a href="#tmle3_task" class="anchor"></a><code>tmle3_Task</code>
</h3>
<p>A <code>tmle3_Task</code> is an object comprised of observed data, and the NPSEM defined above:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">tmle_task &lt;-<span class="st"> </span>tmle3_Task<span class="op">$</span><span class="kw">new</span>(cpp, <span class="dt">npsem =</span> npsem)</a></code></pre></div>
<p>This task object contains methods to help subset the data as needed for various steps in the TMLE process:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># get the outcome node data</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(tmle_task<span class="op">$</span><span class="kw">get_tmle_node</span>(<span class="st">"Y"</span>))</a></code></pre></div>
<pre><code>## [1] 1 1 1 0 0 1</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># get the sl3 task corresponding to an outcome regression</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">tmle_task<span class="op">$</span><span class="kw">get_regression_task</span>(<span class="st">"Y"</span>)</a></code></pre></div>
<pre><code>## A sl3 Task with 1441 obs and these nodes:
## $covariates
##          A         W1         W2         W3         W4         W5         W6 
## "parity01"   "apgar1"   "apgar5" "gagebrth"     "mage" "meducyrs"     "sexn" 
## 
## $outcome
## [1] "haz01"
## 
## $id
## NULL
## 
## $weights
## NULL
## 
## $offset
## NULL</code></pre>
<p>A <code>tmle3_Task</code> is a special kind of <code>sl3_Task</code> that can be used to estimate factors of a likelihood from data. The process of defining and estimating a likelihood is described next.</p>
</div>
</div>
<div id="likelihood" class="section level1">
<h1 class="hasAnchor">
<a href="#likelihood" class="anchor"></a>Likelihood</h1>
<p>Having defined the NPSEM, we can now define a joint likelihood (probability density function) over the observed variables <span class="math inline">\(X\)</span>:</p>
<p><span class="math display">\[P(X_1, \ldots, X_J \in D) = \int_D f_{X_1, \ldots, X_J}(x_1, \ldots, x_J)
dx_1, \ldots, dx_J\]</span></p>
<p>This can then be factorized into a series of conditional densities according to the NPSEM: <span class="math display">\[f_{X_1, \ldots, X_J} = \prod_j^J f_{X_j \mid Pa(X_j)}(x \mid Pa(x_j))\]</span></p>
<p>Where each <span class="math inline">\(f_{X_j \mid Pa(X_j)}\)</span> is a conditional pdf (or probability mass function for discrete <span class="math inline">\(X_j\)</span>), where the conditioning set is all parent nodes as defined in the NPSEM. We refer to these objects as <em>likelihood factors</em>.</p>
<p>TMLE depends on estimates (or <em>a priori</em> knowledge) of the functional form of these likelihood factors. However, not all factors of the likelihood are always necessary for estimation, and only those necessary will be estimated.</p>
<div id="likelihood-factor-objects" class="section level3">
<h3 class="hasAnchor">
<a href="#likelihood-factor-objects" class="anchor"></a>Likelihood Factor Objects</h3>
<p><code>tmle3</code> models this likelihood as a list of likelihood factor objects, where each likelihood factor object describes either <em>a priori</em> knowledge or an estimation strategy for the corresponding likelihood factor. These objects all inherit from the <code>LF_base</code> base class, and there are different types depending on which of a range of estimation strategies or <em>a priori</em> knowledge is appropriate.</p>
<p>In some cases, a full conditional density for a particular factor is not necessary. Instead, a conditional mean – a much easier quantity to estimate – is all that’s required. Although conditional means are not truly likelihood factors, conditional means are also modeled using using likelihood factor objects.</p>
</div>
<div id="lf_emp" class="section level3">
<h3 class="hasAnchor">
<a href="#lf_emp" class="anchor"></a><code>LF_emp</code>
</h3>
<p><code>LF_emp</code> represents a likelihood factor to be estimated using nonparametric maximum likelihood estimation (NP-MLE). That is, probability mass <span class="math inline">\(\frac{1}{n}\)</span> is placed on each observation in the observed dataset:</p>
<p><span class="math display">\[f_{X_j}(x_j) = \frac{1}{n}\mathbb{I}(x_j \in X_{n,j})\]</span></p>
<p>Going forward, weights will be used if specified, although this is not yet supported. <code>LF_emp</code> only supports marginal densities. That is, the conditioning set, <span class="math inline">\(Pa(X_j)\)</span> must be empty. Therefore, it is only appropriate for estimation of the marginal density of baseline covariates.</p>
</div>
<div id="lf_fit" class="section level3">
<h3 class="hasAnchor">
<a href="#lf_fit" class="anchor"></a><code>LF_fit</code>
</h3>
<p><code>LF_fit</code> represents a likelihood factor to be estimated using the <code>sl3</code> framework. Based on the learner type used, this can fit a pmf (for binomial or categorical data, see <code><a href="https://tlverse.org/sl3/reference/list_learners.html">sl3_list_learners("binomial")</a></code> and <code><a href="https://tlverse.org/sl3/reference/list_learners.html">sl3_list_learners("categorical")</a></code> for lists), a conditional mean (most learners), or a conditional density (e.g., using a semiparametric conditional density estimator via <code>Lrnr_density_semiparametric</code>). <code>LF_fit</code> takes a <code>sl3</code> learner object as an argument, which is fit to the data in the <code>tmle3_Task</code> automatically. Details for specifying different kinds of learners in <code>sl3</code> may be found at <a href="http://tlverse.org/sl3/articles/intro_sl3.html" class="uri">http://tlverse.org/sl3/articles/intro_sl3.html</a></p>
</div>
<div id="specifying-a-priori-knowledge-" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-a-priori-knowledge-" class="anchor"></a>Specifying <em>a priori</em> knowledge.</h3>
<p>The above to likelihood factor types, <code>LF_fit</code>, and <code>LF_emp</code>, are both likelihood factors where the factor is estimated from data. In some cases, users may have <em>a priori</em> knowledge of a likelihood factor. For instance, in an RCT, there might be an unconditional probability of treatment of <span class="math inline">\(p = 0.5\)</span>. Additional likelihood factor types need to be create to accommodate this type of knowledge.</p>
</div>
<div id="example-1" class="section level3">
<h3 class="hasAnchor">
<a href="#example-1" class="anchor"></a>Example</h3>
<p>Going back to our CPP data example, we will estimate the marginal likelihood of <span class="math inline">\(W\)</span>, using NP-MLE, the conditional density of <span class="math inline">\(A\)</span> given <span class="math inline">\(W\)</span> using a GLM fit via <code>sl3</code> and the conditional mean of <span class="math inline">\(Y\)</span> given <span class="math inline">\(A\)</span> and <span class="math inline">\(W\)</span> using another GLM fit via <code>sl3</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># set up sl3 learners for tmle3 fit</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">lrnr_glm_fast &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span>(Lrnr_glm_fast)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">lrnr_mean &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span>(Lrnr_mean)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># define and fit likelihood</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">factor_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="kw"><a href="../reference/define_lf.html">define_lf</a></span>(LF_emp, <span class="st">"W"</span>),</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  <span class="kw"><a href="../reference/define_lf.html">define_lf</a></span>(LF_fit, <span class="st">"A"</span>, lrnr_glm_fast),</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  <span class="kw"><a href="../reference/define_lf.html">define_lf</a></span>(LF_fit, <span class="st">"Y"</span>, lrnr_glm_fast, <span class="dt">type=</span><span class="st">"mean"</span>)</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">)</a></code></pre></div>
<p>The particular likelihood factors and estimation strategies to use will of course depend on the parameter of interest. Once this list of likelihood factors is defined, we can construct a <code>Likelihood</code> object and train it on the data contained in <code>tmle_task</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">likelihood_def &lt;-<span class="st"> </span>Likelihood<span class="op">$</span><span class="kw">new</span>(factor_list)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">likelihood &lt;-<span class="st"> </span>likelihood_def<span class="op">$</span><span class="kw">train</span>(tmle_task)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(likelihood)</a></code></pre></div>
<pre><code>## W: Lf_emp
## A: LF_fit
## Y: LF_fit</code></pre>
<p>A <code>tmle3</code> <code>Likelihood</code> is actually a special type of <code>sl3</code> learner, so the syntax to train it on data is analogous.</p>
<p>Having fit the likelihood, we can now get likelihood values for any <code>tmle3_Task</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">likelihood_values &lt;-<span class="st"> </span>likelihood<span class="op">$</span><span class="kw">get_likelihoods</span>(tmle_task,<span class="st">"Y"</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(likelihood_values)</a></code></pre></div>
<pre><code>## [1] 0.5792991 0.5792991 0.6909451 0.6909451 0.6909451 0.4523370</code></pre>
</div>
<div id="counterfactual-likelihoods" class="section level2">
<h2 class="hasAnchor">
<a href="#counterfactual-likelihoods" class="anchor"></a>Counterfactual Likelihoods</h2>
<p>In <code>tmle3</code>, interventions are modeled by likelihoods where one or more likelihood factors is replaced with a counterfactual version representing some intervention.</p>
<p><code>tmle3</code> defines the <code>CF_Likelihood</code> class, which inherits from <code>Likelihood</code>, and takes an <code>observed_likelihood</code> and an <code>intervention_list</code>.</p>
<p>Below, we describe some examples of additional likelihood factors intended to be used to describe interventions. We expect this list to grow as <code>tmle3</code> is extended to additional use-cases.</p>
<div id="lf_static" class="section level3">
<h3 class="hasAnchor">
<a href="#lf_static" class="anchor"></a><code>LF_static</code>
</h3>
<p>Likelihood factor for a static intervention, where all observations are set do a single intervention value <span class="math inline">\(x'\)</span>:</p>
<p><span class="math display">\[f_{X_j \mid Pa(X_j)}(x_j \mid Pa(x_j)) = \mathbf{I}(x_j = x')\]</span></p>
</div>
<div id="other-intervention-likelihood-factor-types" class="section level3">
<h3 class="hasAnchor">
<a href="#other-intervention-likelihood-factor-types" class="anchor"></a>Other intervention likelihood factor types</h3>
<p>Additional likelihood factor types need to be defined for other types of interventions, such as dynamic rules and stochastic interventions. Currently, a prototype version of a stochastic shift intervention exists in <code>LF_shift</code>.</p>
</div>
<div id="example-2" class="section level3">
<h3 class="hasAnchor">
<a href="#example-2" class="anchor"></a>Example</h3>
<p>For our CPP example, we’ll define a simple intervention where we set all treatment <span class="math inline">\(A = 1\)</span>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">intervention &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_lf.html">define_lf</a></span>(LF_static, <span class="st">"A"</span>, <span class="dt">value =</span> <span class="dv">1</span>)</a></code></pre></div>
<p>We can then use this to construct a counterfactual likelihood:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">cf_likelihood &lt;-<span class="st"> </span><span class="kw"><a href="../reference/CF_Likelihood.html">make_CF_Likelihood</a></span>(likelihood, intervention)</a></code></pre></div>
<p>A <code>cf_likelihood</code> is a likelihood object, and so has the same behavior as the observed likelihood object defined above, but with the observed likelihood factors being replaced by the defined intervention likelihood factors.</p>
<p>In particular, we can get likelihood values under the counterfactual likelihood:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">cf_likelihood_values &lt;-<span class="st"> </span>cf_likelihood<span class="op">$</span><span class="kw">get_likelihoods</span>(tmle_task, <span class="st">"A"</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(cf_likelihood_values)</a></code></pre></div>
<pre><code>## [1] 1 1 0 0 0 1</code></pre>
<p>We see that the likelihood values for the <span class="math inline">\(A\)</span> node are all either 0 or 1, as would be expected from an indicator likelihood function. In addition, the likelihood values for the non-intervention nodes have not changed.</p>
</div>
<div id="counterfactual-tasks" class="section level3">
<h3 class="hasAnchor">
<a href="#counterfactual-tasks" class="anchor"></a>Counterfactual Tasks</h3>
<p>Each <code>CF_Likelihood</code> can generate one or more counterfactual tasks. These are <code>tmle3_Task</code>s in which observed values are replaced with counterfactual values according to the specified intervention distribution. For deterministic interventions, only one task will be generated. However, stochastic interventions, when implemented, will generate several such tasks, one for each combination of possible values of the intervention node(s).</p>
<p>To enumerate these tasks, use <code>enumerate_cf_tasks</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">cf_likelihood_tasks &lt;-<span class="st"> </span>cf_likelihood<span class="op">$</span><span class="kw">enumerate_cf_tasks</span>(tmle_task)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(cf_likelihood_tasks[[<span class="dv">1</span>]]<span class="op">$</span>data)</a></code></pre></div>
<pre><code>##    apgar1 apgar5 gagebrth mage meducyrs sexn parity01 haz01
## 1:      8      9      287   21       12    1        1     1
## 2:      8      9      287   21       12    1        1     1
## 3:      8      9      280   15        0    1        1     1
## 4:      8      9      280   15        0    1        1     0
## 5:      8      9      280   15        0    1        1     0
## 6:      9      9      266   23        0    1        1     1</code></pre>
<p>In this case, you can see that <code>parity01</code> has been set to 1 for all observations, consistent with a static intervention on this node.</p>
</div>
</div>
</div>
<div id="update-procedure" class="section level1">
<h1 class="hasAnchor">
<a href="#update-procedure" class="anchor"></a>Update Procedure</h1>
<p>In the TMLE framework, we define a target parameter <span class="math inline">\(\Psi(P)\)</span> as a mapping from a probability distribution <span class="math inline">\(P \in \mathcal{M}\)</span> to a set of real numbers <span class="math inline">\(\mathbb{R}^d\)</span>. Here <span class="math inline">\(\mathcal{M}\)</span> is implied by the NPSEM we defined above.</p>
<p>In <code>tmle3</code>, we define parameter objects as objects inheriting from the <code>Param_base</code> class, which keep track of not only the mapping from a probability distribution to a parameter value, but also the corresponding EIF of the parameter, and the “clever covariates” needed to calculate a TMLE update to the likelihood.</p>
<p>Here, we define a treatment-specific mean (TSM) parameter based on the intervention we defined previously:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">tsm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_param.html">define_param</a></span>(Param_TSM, likelihood, intervention)</a></code></pre></div>
<pre><code>## Warning in super$initialize(observed_likelihood, ..., outcome_node =
## outcome_node): Parameter was passed a non-Targeted Likelihood object so
## estimates cannot be updated from initial</code></pre>
<p><strong>TODO</strong>: provide details about parameter definition</p>
</div>
<div id="update-procedure-1" class="section level1">
<h1 class="hasAnchor">
<a href="#update-procedure-1" class="anchor"></a>Update Procedure</h1>
<p>The update procedure component of <code>tmle3</code> is currently in flux. The current structure is as follows:</p>
<p>We have an object, <code>tmle3_Update</code>, which calculates the individual update steps using <code>tmle3_Update$update_step</code>. This adds to a <code>Likelihood$update_list</code>, so that future calls to <code>Likelihood$get_likelihoods</code> will return updated likelihood values. However, likelihood values are generally recomputed at each step, which requires applying all past updates. This is ridiculously inefficient.</p>
<p>Instead, we need to do what previous TMLE implementations have done, which is enumerate a list of required likelihood values, and update those values as we go (as opposed to updating the function and recalculating the value each time they are needed). This requires the ability to have the parameters enumerate which likelihood values they will need for defining the clever covariate, as well as parameter mapping and the EIF. This has not yet been implemented.</p>
<p>Therefore, the update procedure, as well as the structure of the <code>Param_base</code> parameter objects are subject to substantial changes in the near future.</p>
<p>Currently, the <code>tmle3_Update</code> object also has a hard-coded submodel (logistic), loss function (log-likelihood), and solver (GLM). These need to be generalized so updates can be done for a range of submodels, loss functions, and solvers.</p>
<p>Current Usage:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">updater &lt;-<span class="st"> </span>tmle3_Update<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">targeted_likelihood &lt;-<span class="st"> </span>Targeted_Likelihood<span class="op">$</span><span class="kw">new</span>(likelihood, updater)</a></code></pre></div>
</div>
<div id="target-parameter" class="section level1">
<h1 class="hasAnchor">
<a href="#target-parameter" class="anchor"></a>Target Parameter</h1>
<p>In the TMLE framework, we define a target parameter <span class="math inline">\(\Psi(P)\)</span> as a mapping from a probability distribution <span class="math inline">\(P \in \mathcal{M}\)</span> to a set of real numbers <span class="math inline">\(\mathbb{R}^d\)</span>. Here <span class="math inline">\(\mathcal{M}\)</span> is implied by the NPSEM we defined above.</p>
<p>In <code>tmle3</code>, we define parameter objects as objects inheriting from the <code>Param_base</code> class, which keep track of not only the mapping from a probability distribution to a parameter value, but also the corresponding EIF of the parameter, and the “clever covariates” needed to calculate a TMLE update to the likelihood.</p>
<p>Here, we define a treatment specific mean (TSM) parameter based on the intervention we defined previously:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">tsm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_param.html">define_param</a></span>(Param_TSM, likelihood, intervention)</a></code></pre></div>
<pre><code>## Warning in super$initialize(observed_likelihood, ..., outcome_node =
## outcome_node): Parameter was passed a non-Targeted Likelihood object so
## estimates cannot be updated from initial</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">updater<span class="op">$</span>tmle_params &lt;-<span class="st"> </span>tsm</a></code></pre></div>
<p><strong>TODO: provide details about parameter definition</strong></p>
</div>
<div id="tmle3_fit---putting-it-all-together" class="section level1">
<h1 class="hasAnchor">
<a href="#tmle3_fit---putting-it-all-together" class="anchor"></a><code>tmle3_Fit</code> - Putting it all together</h1>
<p>Now that we have specified all the components required for the TMLE procedure, we can generate an object that manages all the components and finally calculate an appropriate TML estimator.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">tmle_fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tmle3_Fit.html">fit_tmle3</a></span>(tmle_task, targeted_likelihood, tsm, updater)</a></code></pre></div>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number):
## Lrnr_glm_fast_TRUE_Cholesky is not a cv-aware learner, so self$predict_fold
## reverts to self$predict

## Warning in learner$predict_fold(learner_task, fold_number):
## Lrnr_glm_fast_TRUE_Cholesky is not a cv-aware learner, so self$predict_fold
## reverts to self$predict

## Warning in learner$predict_fold(learner_task, fold_number):
## Lrnr_glm_fast_TRUE_Cholesky is not a cv-aware learner, so self$predict_fold
## reverts to self$predict</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(tmle_fit)</a></code></pre></div>
<pre><code>## A tmle3_Fit that took 1 step(s)
##    type      param  init_est  tmle_est         se     lower     upper
## 1:  TSM E[Y_{A=1}] 0.5280522 0.5280522 0.01464371 0.4993511 0.5567533
##    psi_transformed lower_transformed upper_transformed
## 1:       0.5280522         0.4993511         0.5567533</code></pre>
</div>
<div id="tmle-specification" class="section level1">
<h1 class="hasAnchor">
<a href="#tmle-specification" class="anchor"></a>TMLE Specification</h1>
<p>The <code>tmle3</code> framework described above is completely general, and allows most components of the TMLE procedure to be specified in a modular way. However, most end users will not be interested in manually specifying all of these components. Therefore, <code>tmle3</code> implements a <code>tmle3_Spec</code> object that bundles a set of components into a <em>specification</em> that, with minimal additional detail, can be run by an end-user:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">nodes &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">W =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"apgar1"</span>, <span class="st">"apgar5"</span>, <span class="st">"gagebrth"</span>, <span class="st">"mage"</span>, <span class="st">"meducyrs"</span>,</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">                    <span class="st">"sexn"</span>),</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">              <span class="dt">A =</span> <span class="st">"parity01"</span>,</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">              <span class="dt">Y =</span> <span class="st">"haz01"</span>)</a>
<a class="sourceLine" id="cb29-5" data-line-number="5"></a>
<a class="sourceLine" id="cb29-6" data-line-number="6">lrnr_glm_fast &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span>(Lrnr_glm_fast)</a>
<a class="sourceLine" id="cb29-7" data-line-number="7">lrnr_mean &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span>(Lrnr_mean)</a>
<a class="sourceLine" id="cb29-8" data-line-number="8">learner_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">Y =</span> lrnr_mean, <span class="dt">A =</span> lrnr_glm_fast)</a>
<a class="sourceLine" id="cb29-9" data-line-number="9"></a>
<a class="sourceLine" id="cb29-10" data-line-number="10"><span class="co"># make a new copy to deal with data.table weirdness</span></a>
<a class="sourceLine" id="cb29-11" data-line-number="11">cpp2 &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">copy</span>(cpp)</a>
<a class="sourceLine" id="cb29-12" data-line-number="12"></a>
<a class="sourceLine" id="cb29-13" data-line-number="13">tmle_fit_from_spec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tmle3.html">tmle3</a></span>(<span class="kw"><a href="../reference/tmle_TSM_all.html">tmle_TSM_all</a></span>(), cpp2, nodes, learner_list)</a></code></pre></div>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number):
## Lrnr_glm_fast_TRUE_Cholesky is not a cv-aware learner, so self$predict_fold
## reverts to self$predict</code></pre>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number): Lrnr_mean is not a
## cv-aware learner, so self$predict_fold reverts to self$predict</code></pre>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number):
## Lrnr_glm_fast_TRUE_Cholesky is not a cv-aware learner, so self$predict_fold
## reverts to self$predict</code></pre>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number): Lrnr_mean is not a
## cv-aware learner, so self$predict_fold reverts to self$predict</code></pre>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number):
## Lrnr_glm_fast_TRUE_Cholesky is not a cv-aware learner, so self$predict_fold
## reverts to self$predict</code></pre>
<pre><code>## Warning in learner$predict_fold(learner_task, fold_number): Lrnr_mean is not a
## cv-aware learner, so self$predict_fold reverts to self$predict</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(tmle_fit_from_spec)</a></code></pre></div>
<pre><code>## A tmle3_Fit that took 1 step(s)
##    type      param init_est  tmle_est         se     lower     upper
## 1:  TSM E[Y_{A=0}]  0.55517 0.6979470 0.04692307 0.6059795 0.7899146
## 2:  TSM E[Y_{A=1}]  0.55517 0.5267412 0.01473676 0.4978577 0.5556247
##    psi_transformed lower_transformed upper_transformed
## 1:       0.6979470         0.6059795         0.7899146
## 2:       0.5267412         0.4978577         0.5556247</code></pre>
<p>Currently, this is effectively a hard-coded list of those details: the structure of the NPSEM, the parameters, and the update procedure are coded into the specification. Only the data, the roles of the variables, and the <code>sl3</code> learners to use for likelihood estimation. Ideally, instead a <code>tmle3_Spec</code> would represent a set of reasonable defaults for a particular TMLE, that experienced users could override where appropriate.</p>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>Obviously, there’s a lot more to do:</p>
<ul>
<li>Generalize <code>tmle3_Update</code>
</li>
<li>Generalize <code>tmpe3_Spec</code>
</li>
<li>Better handling of bounded continuous outcomes</li>
<li>Expand documentation of parameter definitions</li>
<li>Add support for dynamic rules and stochastic interventions</li>
<li>CV-TMLE</li>
<li>C-TMLE</li>
<li>IPCW-TMLE</li>
<li>Extension to longitudinal data settings</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#npsem">NPSEM</a></li>
      <li>
<a href="#likelihood">Likelihood</a><ul class="nav nav-pills nav-stacked">
<li><a href="#counterfactual-likelihoods">Counterfactual Likelihoods</a></li>
      </ul>
</li>
      <li><a href="#update-procedure">Update Procedure</a></li>
      <li><a href="#update-procedure-1">Update Procedure</a></li>
      <li><a href="#target-parameter">Target Parameter</a></li>
      <li><a href="#tmle3_fit---putting-it-all-together"><code>tmle3_Fit</code> - Putting it all together</a></li>
      <li><a href="#tmle-specification">TMLE Specification</a></li>
      <li><a href="#conclusion">Conclusion</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jeremy Coyle.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
